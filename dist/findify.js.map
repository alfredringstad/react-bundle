{"version":3,"file":"findify.js","sources":["../index.js"],"sourcesContent":["import { useRef, useEffect, useState } from 'react';\nimport { useHistory } from \"react-router-dom\";\n\nconst eventBindings = {\n  autocomplete: 'change:suggestions',\n  recommendation: 'change:items',\n  search: 'change:items',\n  'smart-collection': 'change:items',\n}\n\nconst randomKey = () => Math.random().toString(36).substring(7)\n\n\nexport const waitForFindify = () => new Promise(resolve =>\n  (window.findifyCallbacks = window.findifyCallbacks || []).push(findify => resolve(findify))\n);\n\nconst getWidgetConfig = (type, node, config, customs) => {\n  if (type !== 'recommendation') return customs;\n  return config\n    .getIn(['features', 'recommendations', '#' + (customs.slot || node.getAttribute('id'))])\n    .mergeDeep(customs);\n};\n\nexport default ({ type, config = {}, options = {}, widgetKey = randomKey() }) => {\n  const container = useRef(null);\n  const [ready, setReady] = useState(false);\n  const [hasError, setError] = useState(false);\n  const history = useHistory();\n\n  useEffect(() => {\n    if (!container.current) return;\n    let findify = void 0;\n    \n    const init = async () => {\n      findify = await waitForFindify();\n      findify.history = history;\n    \n      const widgetConfig = getWidgetConfig(\n        type,\n        container.current,\n        findify.config,\n        {\n          widgetKey,\n          disableAutoRequest: true,\n          ...config,\n        }\n      );\n    \n      findify.widgets.attach(container.current, type, widgetConfig)\n\n      const widget = findify.widgets.get(widgetKey)\n\n      const meta = widget.config.get('meta') && widget.config.get('meta').toJS() || {};\n  \n      const defaults = {\n        ...meta,\n        ...options\n      }\n\n      if (type === 'recommendation') {\n        defaults.slot = config.slot;\n        defaults.type = config.type || widgetConfig.get('type');\n      }\n\n      if (type === 'smart-collection') {\n        defaults.slot = config.slot || findify.utils.collectionPath();\n      }\n\n      widget.agent\n        .defaults(defaults)\n        .once('error', () => setError(true))\n        .once(eventBindings[type], (items) => {\n          if (!items.length) setError(true)\n          setReady(true);\n        })\n\n      if (['search', 'smart-collection'].includes(type)) {\n        widget.agent.applyState(findify.utils.getQuery())\n      }\n    }\n\n    init();\n\n    return () => {\n      findify.widgets.detach(widgetKey)\n    }\n  }, [container]);\n\n  return [container, ready, hasError];\n}\n"],"names":["eventBindings","autocomplete","recommendation","search","randomKey","Math","random","toString","substring","waitForFindify","Promise","resolve","window","findifyCallbacks","push","findify","getWidgetConfig","type","node","config","customs","getIn","slot","getAttribute","mergeDeep","options","widgetKey","container","useRef","useState","ready","setReady","hasError","setError","history","useHistory","useEffect","current","init","widgetConfig","disableAutoRequest","widgets","attach","widget","get","meta","toJS","defaults","utils","collectionPath","agent","once","items","length","includes","applyState","getQuery","detach"],"mappings":"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"}