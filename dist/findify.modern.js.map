{"version":3,"file":"findify.modern.js","sources":["../index.js"],"sourcesContent":["import { useRef, useEffect, useState } from 'react';\nimport { useHistory } from \"react-router-dom\";\n\nconst eventBindings = {\n  autocomplete: 'change:suggestions',\n  recommendation: 'change:items',\n  search: 'change:items',\n}\n\nconst randomKey = () => Math.random().toString(36).substring(7)\n\n\nconst waitForFindify = () => new Promise(resolve =>\n  (window.findifyCallbacks = window.findifyCallbacks || []).push(findify => resolve(findify))\n);\n\nconst getWidgetConfig = (type, node, config, customs) => {\n  const cfg = type === 'recommendation'\n    && config.getIn(['features', 'recommendations', '#' + (customs.slot || node.getAttribute('id'))])\n    || config.getIn(['features', type]);\n\n  return config.withMutations(c =>\n      c.mergeDeep(cfg)\n      .mergeDeep(customs)\n      .set('node', node)\n      .set('cssSelector', `findify-${type} findify-widget-${customs.widgetKey}`)\n      .toJS()\n    );\n};\n\nexport default ({ type, config = {}, options = {}, widgetKey = randomKey() }) => {\n  const container = useRef(null);\n  const [ready, setReady] = useState(false);\n  const history = useHistory();\n\n  useEffect(() => {\n    if (!container.current) return;\n    let findify = void 0;\n    \n    const init = async () => {\n      findify = await waitForFindify();\n      findify.history = history;\n    \n      const widgetConfig = getWidgetConfig(\n        type,\n        container.current,\n        findify.config,\n        {\n          widgetKey,\n          disableAutoRequest: type !== 'recommendation',\n          ...config,\n        }\n      );\n    \n      findify.widgets.attach(container.current, type, widgetConfig)\n\n      const widget = findify.widgets.get(widgetKey)\n\n      const meta = widget.config.get('meta') && widget.config.get('meta').toJS() || {};\n      widget.agent.defaults({ ...meta, ...options }).once(eventBindings[type], () => setReady(true))\n\n      if (['search', 'smart-collection'].includes(type)) {\n        widget.agent.applyState(findify.utils.getQuery())\n      }  \n    }\n\n    init();\n\n    return () => {\n      findify.widgets.detach(widgetKey)\n    }\n  }, [container]);\n\n  return [container, ready];\n}\n"],"names":["eventBindings","autocomplete","recommendation","search","randomKey","Math","random","toString","substring","waitForFindify","Promise","resolve","window","findifyCallbacks","push","findify","getWidgetConfig","type","node","config","customs","cfg","getIn","slot","getAttribute","withMutations","c","mergeDeep","set","widgetKey","toJS","options","container","useRef","ready","setReady","useState","history","useHistory","useEffect","current","init","widgetConfig","disableAutoRequest","widgets","attach","widget","get","meta","agent","defaults","once","includes","applyState","utils","getQuery","detach"],"mappings":"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"}