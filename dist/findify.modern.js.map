{"version":3,"file":"findify.modern.js","sources":["../index.js"],"sourcesContent":["import { useRef, useEffect, useState } from 'react';\n\nconst eventBindings = {\n  autocomplete: 'change:suggestions',\n  recommendation: 'change:items',\n  search: 'change:items',\n  'smart-collection': 'change:items',\n}\n\nconst randomKey = () => Math.random().toString(36).substring(7)\n\n\nexport const waitForFindify = () => new Promise(resolve =>\n  (window.findifyCallbacks = window.findifyCallbacks || []).push(findify => resolve(findify))\n);\n\nconst getWidgetConfig = (type, node, config, customs) => {\n  if (type !== 'recommendation') return customs;\n  return config\n    .getIn(['features', 'recommendations', '#' + (customs.slot || node.getAttribute('id'))])\n    .mergeDeep(customs);\n};\n\nexport default ({ type, config = {}, options = {}, history, widgetKey = randomKey() }) => {\n  const container = useRef(null);\n  const [ready, setReady] = useState(false);\n  const [hasError, setError] = useState(false);\n\n  useEffect(() => {\n    if (!container.current) return;\n    let findify = void 0;\n    let shouldRender = true;\n    \n    const init = async () => {\n      findify = await waitForFindify();\n      if (!shouldRender) return;\n  \n      if (history) findify.utils.history = history;\n    \n      const widgetConfig = getWidgetConfig(\n        type,\n        container.current,\n        findify.config,\n        {\n          widgetKey,\n          disableAutoRequest: true,\n          ...config,\n        }\n      );\n    \n      findify.widgets.attach(\n        container.current,\n        type === 'smart-collection' ? 'search' : type,\n        widgetConfig\n      )\n\n      const widget = findify.widgets.get(widgetKey)\n\n      const meta = widget.config.get('meta') && widget.config.get('meta').toJS() || {};\n  \n      const defaults = {\n        ...meta,\n        ...options\n      }\n\n      if (type === 'recommendation') {\n        defaults.slot = config.slot;\n        defaults.type = config.type || widgetConfig.get('type');\n      }\n\n      if (type === 'smart-collection') {\n        defaults.slot = config.slot || findify.utils.collectionPath();\n      }\n\n      const callback = (items) => window.requestAnimationFrame(() => {\n        widget.agent.off(callback)\n        if (!items.size) setError(true)\n        setReady(true);\n      })\n\n      widget.agent\n        .defaults(defaults)\n        .on('error', () => setError(true))\n        .on(eventBindings[type], callback)\n\n      if (['search', 'smart-collection'].includes(type)) {\n        widget.agent.applyState(findify.utils.getQuery())\n      }\n    }\n\n    init();\n\n    return () => {\n      console.log('detach', widgetKey)\n      if (findify) {\n        findify.widgets.detach(widgetKey)\n      } else {\n        shouldRender = false\n      }\n    }\n  }, [container]);\n\n  return [container, ready, hasError];\n}\n"],"names":["eventBindings","autocomplete","recommendation","search","smart-collection","randomKey","Math","random","toString","substring","waitForFindify","Promise","resolve","window","findifyCallbacks","push","findify","type","config","options","history","widgetKey","container","useRef","ready","setReady","useState","hasError","setError","useEffect","current","shouldRender","async","utils","widgetConfig","node","customs","getIn","slot","getAttribute","mergeDeep","getWidgetConfig","disableAutoRequest","widgets","attach","widget","get","defaults","toJS","collectionPath","callback","items","requestAnimationFrame","agent","off","size","on","includes","applyState","getQuery","init","console","log","detach"],"mappings":"2QAEA,MAAMA,EAAgB,CACpBC,aAAc,qBACdC,eAAgB,eAChBC,OAAQ,eACRC,mBAAoB,gBAGhBC,EAAY,IAAMC,KAAKC,SAASC,SAAS,IAAIC,UAAU,GAGhDC,EAAiB,IAAM,IAAIC,QAAQC,IAC7CC,OAAOC,iBAAmBD,OAAOC,kBAAoB,IAAIC,KAAKC,GAAWJ,EAAQI,qBAUlEC,KAAAA,EAAMC,OAAAA,EAAS,GAAIC,QAAAA,EAAU,GAAIC,QAAAA,EAASC,UAAAA,EAAYhB,QACtE,MAAMiB,EAAYC,EAAO,OAClBC,EAAOC,GAAYC,GAAS,IAC5BC,EAAUC,GAAYF,GAAS,GA4EtC,OA1EAG,EAAU,KACR,IAAKP,EAAUQ,QAAS,OACxB,IAAId,EACAe,GAAe,EA6DnB,MA3DaC,WAEX,GADAhB,QAAgBN,KACXqB,EAAc,OAEfX,IAASJ,EAAQiB,MAAMb,QAAUA,GAErC,MAAMc,EAvBY,EAACjB,EAAMkB,EAAMjB,EAAQkB,IAC9B,mBAATnB,EAAkCmB,EAC/BlB,EACJmB,MAAM,CAAC,WAAY,kBAAmB,KAAOD,EAAQE,MAAQH,EAAKI,aAAa,SAC/EC,UAAUJ,GAmBYK,CACnBxB,EACAK,EAAUQ,QACVd,EAAQE,UAENG,UAAAA,EACAqB,oBAAoB,GACjBxB,IAIPF,EAAQ2B,QAAQC,OACdtB,EAAUQ,QACD,qBAATb,EAA8B,SAAWA,EACzCiB,GAGF,MAAMW,EAAS7B,EAAQ2B,QAAQG,IAAIzB,GAI7B0B,OAFOF,EAAO3B,OAAO4B,IAAI,SAAWD,EAAO3B,OAAO4B,IAAI,QAAQE,QAAU,GAIzE7B,GAGQ,mBAATF,IACF8B,EAAST,KAAOpB,EAAOoB,KACvBS,EAAS9B,KAAOC,EAAOD,MAAQiB,EAAaY,IAAI,SAGrC,qBAAT7B,IACF8B,EAAST,KAAOpB,EAAOoB,MAAQtB,EAAQiB,MAAMgB,kBAG/C,MAAMC,EAAYC,GAAUtC,OAAOuC,sBAAsB,KACvDP,EAAOQ,MAAMC,IAAIJ,GACZC,EAAMI,MAAM3B,GAAS,GAC1BH,GAAS,KAGXoB,EAAOQ,MACJN,SAASA,GACTS,GAAG,QAAS,IAAM5B,GAAS,IAC3B4B,GAAGxD,EAAciB,GAAOiC,GAEvB,CAAC,SAAU,oBAAoBO,SAASxC,IAC1C4B,EAAOQ,MAAMK,WAAW1C,EAAQiB,MAAM0B,aAI1CC,GAEO,KACLC,QAAQC,IAAI,SAAUzC,GAClBL,EACFA,EAAQ2B,QAAQoB,OAAO1C,GAEvBU,GAAe,IAGlB,CAACT,IAEG,CAACA,EAAWE,EAAOG"}